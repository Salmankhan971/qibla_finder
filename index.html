<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Qibla Compass</title>
<style>
  body { background:#0f172a; color:#fff; font-family:sans-serif; text-align:center; margin:0; padding:20px; }
  h1 { margin-bottom:10px; }
  #compass {
    width:300px; height:300px;
    border:10px solid #38bdf8;
    border-radius:50%;
    margin:20px auto;
    position:relative;
    overflow:hidden;
  }
  #dial {
    width:100%; height:100%;
    position:absolute; top:0; left:0;
    background:radial-gradient(circle,#1e293b 60%,#0f172a 100%);
    border-radius:50%;
    transition: transform 0.1s linear;
  }
  #dial::before {
    content:"N";
    position:absolute; top:10px; left:50%;
    transform:translateX(-50%);
    font-weight:bold; color:#38bdf8;
  }
  #arrow {
    position:absolute;
    top:50%; left:50%;
    width:6px; height:120px;
    background:#f87171;
    transform-origin:bottom center;
    border-radius:3px;
  }
  .info { margin-top:15px; }
  button {
    margin:8px; padding:10px 16px; border:none;
    border-radius:6px; background:#38bdf8; color:#000;
    font-weight:bold; cursor:pointer;
  }
  button:hover { background:#0ea5e9; }
</style>
</head>
<body>
  <h1>Qibla Direction Finder</h1>
  <div id="compass">
    <div id="dial"></div>
    <div id="arrow"></div>
  </div>
  <div class="info">
    <p><b>Your Heading:</b> <span id="heading">—</span>°</p>
    <p><b>Qibla Bearing:</b> <span id="bearing">—</span>°</p>
    <p><b>Turn:</b> <span id="turn">—</span></p>
    <p><b>Location:</b> <span id="location">—</span></p>
  </div>
  <div>
    <button onclick="getLocation()">Get My Location</button>
    <button onclick="enableCompass()">Enable Compass</button>
  </div>

<script>
const KAABA = { lat: 21.4225 * Math.PI/180, lon: 39.8262 * Math.PI/180 };
let state = { lat:null, lon:null, bearing:null, heading:null };

function toRad(d){ return d*Math.PI/180; }
function toDeg(r){ return r*180/Math.PI; }

function qiblaBearing(lat, lon) {
  const φ1=toRad(lat), λ1=toRad(lon);
  const φ2=KAABA.lat, λ2=KAABA.lon;
  const dλ=λ2-λ1;
  const y=Math.sin(dλ)*Math.cos(φ2);
  const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(dλ);
  return (toDeg(Math.atan2(y,x))+360)%360;
}

function getLocation() {
  if (!navigator.geolocation) { alert("Geolocation not supported"); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    state.lat=pos.coords.latitude;
    state.lon=pos.coords.longitude;
    state.bearing=qiblaBearing(state.lat,state.lon);
    document.getElementById("bearing").textContent=state.bearing.toFixed(1);
    document.getElementById("location").textContent=state.lat.toFixed(5)+", "+state.lon.toFixed(5);
  },err=>alert("Location error: "+err.message),{enableHighAccuracy:true});
}

function enableCompass() {
  if (typeof DeviceOrientationEvent!=="undefined" && typeof DeviceOrientationEvent.requestPermission==="function") {
    DeviceOrientationEvent.requestPermission().then(res=>{
      if(res==="granted"){ window.addEventListener("deviceorientation", handleOrientation, true); }
      else alert("Compass permission denied");
    });
  } else {
    window.addEventListener("deviceorientationabsolute", handleOrientation, true);
    window.addEventListener("deviceorientation", handleOrientation, true);
  }
}

function handleOrientation(e) {
  let heading;
  if (e.webkitCompassHeading) { heading=e.webkitCompassHeading; } // iOS
  else if (e.alpha!=null) { heading=360-e.alpha; } // Android
  if(heading!=null){
    state.heading=(heading+360)%360;
    document.getElementById("heading").textContent=state.heading.toFixed(1);
    updateCompass();
  }
}

function updateCompass() {
  if(state.bearing==null || state.heading==null) return;
  const dial=document.getElementById("dial");
  const arrow=document.getElementById("arrow");

  // rotate dial to show heading
  dial.style.transform=`rotate(${state.heading}deg)`;

  // arrow points to Qibla relative to heading
  const relAngle=(state.bearing - state.heading + 360)%360;
  arrow.style.transform=`translate(-50%,-100%) rotate(${relAngle}deg)`;

  // turn direction
  let delta=((state.bearing - state.heading + 540)%360)-180;
  const dir=delta>=0?"right":"left";
  document.getElementById("turn").textContent=Math.abs(delta).toFixed(1)+"° "+dir;
}
</script>
</body>
</html>
