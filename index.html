<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Accurate Qibla Finder</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #0b1020; color: #fff; text-align: center; }
  h1 { font-size: 22px; margin: 16px 0; }
  #compass { width: 280px; height: 280px; border: 6px solid #4fd1c5; border-radius: 50%; margin: 20px auto; position: relative; }
  #arrow { position: absolute; top: 50%; left: 50%; width: 4px; height: 120px; background: #4fd1c5; transform-origin: bottom center; }
  #info { margin-top: 20px; }
  button { margin: 8px; padding: 10px 16px; border: none; border-radius: 6px; background: #4fd1c5; color: #000; font-weight: bold; cursor: pointer; }
  button:hover { background: #36afa7; }
</style>
</head>
<body>
  <h1>Qibla Direction Finder</h1>
  <div id="compass">
    <div id="arrow"></div>
  </div>
  <div id="info">
    <p><b>Your Heading:</b> <span id="heading">—</span>°</p>
    <p><b>Qibla Bearing:</b> <span id="bearing">—</span>°</p>
    <p><b>Turn:</b> <span id="turn">—</span></p>
    <p><b>Location:</b> <span id="location">—</span></p>
  </div>
  <div>
    <button onclick="getLocation()">Get My Location</button>
    <button onclick="enableCompass()">Enable Compass</button>
  </div>

<script>
const KAABA = { lat: 21.4225 * Math.PI/180, lon: 39.8262 * Math.PI/180 }; // radians
let state = { lat: null, lon: null, bearing: null, heading: null };

function toRad(d){ return d*Math.PI/180; }
function toDeg(r){ return r*180/Math.PI; }

function qiblaBearing(lat, lon) {
  const φ1 = toRad(lat), λ1 = toRad(lon);
  const φ2 = KAABA.lat, λ2 = KAABA.lon;
  const dλ = λ2 - λ1;
  const y = Math.sin(dλ) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(dλ);
  return (toDeg(Math.atan2(y, x)) + 360) % 360;
}

function getLocation() {
  if (!navigator.geolocation) { alert("Geolocation not supported"); return; }
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    state.lat = lat; state.lon = lon;
    state.bearing = qiblaBearing(lat, lon);
    document.getElementById("bearing").textContent = state.bearing.toFixed(1);
    document.getElementById("location").textContent = lat.toFixed(6)+", "+lon.toFixed(6);
  }, err => alert("Location error: " + err.message), { enableHighAccuracy:true });
}

function enableCompass() {
  if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
    DeviceOrientationEvent.requestPermission().then(res => {
      if (res === "granted") {
        window.addEventListener("deviceorientation", handleOrientation, true);
      } else alert("Compass permission denied");
    });
  } else {
    window.addEventListener("deviceorientationabsolute", handleOrientation, true);
    window.addEventListener("deviceorientation", handleOrientation, true);
  }
}

function handleOrientation(e) {
  let heading;
  if (e.webkitCompassHeading) { // iOS
    heading = e.webkitCompassHeading;
  } else if (e.alpha != null) { // Android
    heading = 360 - e.alpha; // normalize
  }
  if (heading != null) {
    state.heading = (heading+360)%360;
    document.getElementById("heading").textContent = state.heading.toFixed(1);
    updateCompass();
  }
}

function updateCompass() {
  if (state.bearing == null || state.heading == null) return;
  let delta = ((state.bearing - state.heading + 540) % 360) - 180; // shortest turn
  const dir = delta >= 0 ? "right" : "left";
  document.getElementById("turn").textContent = Math.abs(delta).toFixed(1)+"° "+dir;
  const rotation = (state.bearing - state.heading + 360) % 360;
  document.getElementById("arrow").style.transform = `translate(-50%,-100%) rotate(${rotation}deg)`;
}
</script>
</body>
</html>
